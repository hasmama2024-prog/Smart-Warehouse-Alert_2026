<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ù„ Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ© - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</title>
    <style>
        /* --- 1. Ø§Ù„ØªØµÙ…ÙŠÙ… (CSS) --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            direction: rtl;
            text-align: right;
            color: var(--dark-bg);
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e9ecef, #ffffff);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-right: 5px solid var(--info-color);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1em;
        }

        .stat-card p {
            font-size: 2em;
            margin: 5px 0 0;
            font-weight: bold;
            color: var(--dark-bg);
        }
        
        #current-time {
            font-size: 1em;
            color: var(--secondary-color);
            margin-top: 10px;
        }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        .actions-bar {
            margin: 30px 0;
            text-align: left; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ */
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .actions-bar button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        /* --- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª --- */
        .alerts-section h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            color: var(--primary-color);
            margin-top: 30px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .alerts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .alerts-table th, .alerts-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: right;
            white-space: nowrap; /* Ù„Ù…Ù†Ø¹ ÙƒØ³Ø± Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        }

        .alerts-table th {
            background-color: var(--dark-bg);
            color: white;
            font-weight: 600;
        }

        .alerts-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .alerts-table tr:hover {
            background-color: #e9e9e9;
        }

        /* --- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ --- */
        .status-new {
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-read {
            background-color: var(--warning-color);
            color: var(--dark-bg);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-solved {
            background-color: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .status-ignored {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) --- */
        .modal {
            display: none; /* Ù…Ø®ÙÙŠ Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .modal-content label, .modal-content input, .modal-content button {
            display: block;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
        }

        .modal-content input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .modal-content button {
            padding: 10px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ù„ Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ© ğŸ‘”</h1>
            <p id="current-time"></p>
        </header>

        <section class="stats-grid">
            <div class="stat-card" style="border-right-color: var(--danger-color);">
                <h3>ğŸš¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                <p id="total-alerts">0</p>
            </div>
            <div class="stat-card" style="border-right-color: var(--primary-color);">
                <h3>ğŸ“‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªØ­Øª Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±</h3>
                <p id="critical-items">0</p>
            </div>
            <div class="stat-card" style="border-right-color: var(--warning-color);">
                <h3>ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</h3>
                <p id="total-value">0 SAR</p>
            </div>
            <div class="stat-card" style="border-right-color: var(--success-color);">
                <h3>âœ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</h3>
                <p id="solved-alerts">0</p>
            </div>
        </section>

        <section class="actions-bar">
            <button class="btn-success" onclick="createBatchPurchaseOrder()">ğŸ“œ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø¬Ù…Ø¹</button>
            <button class="btn-primary" onclick="openSalesModal()">ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ®ÙÙŠØ¶Ø§Øª</button>
        </section>

        <section class="alerts-section">
            <h2>Ù‚Ø§Ø¦Ù…Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
            <div class="table-responsive">
                <table class="alerts-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                            <th>Ø§Ù„Ø³Ø¹Ø± (ØªÙƒÙ„ÙØ© / Ø¨ÙŠØ¹)</th>
                            <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-body">
                        </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('purchaseModal')">&times;</span>
            <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</h2>
            <p>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: <span id="purchaseProductName"></span></p>
            <input type="number" id="purchaseQuantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ø§Ù„Ø­Ø¨Ø©)" value="100" min="10">
            <input type="number" id="purchaseCost" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø© (SAR)" min="0.01">
            <input type="text" id="purchaseSupplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <span id="purchaseTotalPrice">0 SAR</span></p>
            <button class="btn-primary" onclick="submitPurchase()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
    </div>

    <div id="salesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('salesModal')">&times;</span>
            <h2>ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªØ®ÙÙŠØ¶Ø§Øª</h2>
            <p>Ø§Ù„Ù…Ù†ØªØ¬: <span id="saleProductName"></span></p>
            <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: <span id="saleOriginalPrice"></span></p>
            <input type="number" id="saleDiscount" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)" min="1" max="100" value="10" oninput="calculateSaleProfit()">
            <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: <span id="saleNewPrice">0 SAR</span></p>
            <p>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©: <span id="saleCostPrice"></span></p>
            <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: <span id="saleProfitStatus" style="font-weight: bold;">ÙŠÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø®ØµÙ…</span></p>
            <button class="btn-success" onclick="submitSaleOffer()">ØªØ£ÙƒÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶</button>
        </div>
    </div>
    
    <div id="ignoreModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('ignoreModal')">&times;</span>
            <h2>ØªØ¬Ø§Ù‡Ù„ ØªÙ†Ø¨ÙŠÙ‡</h2>
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ù†ØªØ¬: <span id="ignoreProductName"></span>ØŸ</p>
            <input type="text" id="ignoreReason" placeholder="Ø§Ø°ÙƒØ± Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ø§Ù‡Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)" required>
            <button class="btn-secondary" onclick="ignoreAlertConfirmed()" style="background-color: var(--secondary-color); color: white;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ø§Ù‡Ù„</button>
        </div>
    </div>

    <script>
        /* --- 2. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª (JavaScript) --- */

        let alerts = [
            // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ù„Ù† ØªÙØ³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Local Storage)
            { id: 1, product: 'Ù‚Ù…ÙŠØµ Ø£Ø¨ÙŠØ¶ ÙƒÙ„Ø§Ø³ÙŠÙƒ', currentStock: 5, minLevel: 50, costPrice: 40, sellingPrice: 80, lastUpdate: '2025-12-01', status: 'Ø¬Ø¯ÙŠØ¯' },
            { id: 2, product: 'Ø¨Ù†Ø·Ù„ÙˆÙ† Ø¬ÙŠÙ†Ø² Ø£Ø²Ø±Ù‚', currentStock: 120, minLevel: 100, costPrice: 60, sellingPrice: 150, lastUpdate: '2025-12-05', status: 'Ù…Ù‚Ø±ÙˆØ¡' },
            { id: 3, product: 'ÙƒÙˆÙÙŠØ© Ø´ØªÙˆÙŠØ© ØµÙˆÙ', currentStock: 0, minLevel: 30, costPrice: 15, sellingPrice: 45, lastUpdate: '2025-11-20', status: 'Ø¬Ø¯ÙŠØ¯' },
            { id: 4, product: 'Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚ Ø­Ø±ÙŠØ± Ø³ÙˆØ¯Ø§Ø¡', currentStock: 25, minLevel: 50, costPrice: 20, sellingPrice: 60, lastUpdate: '2025-12-09', status: 'Ø¬Ø¯ÙŠØ¯' },
            { id: 5, product: 'Ø¬Ø§ÙƒÙŠØª Ø¬Ù„Ø¯ Ø£Ø³ÙˆØ¯', currentStock: 80, minLevel: 70, costPrice: 250, sellingPrice: 500, lastUpdate: '2025-12-08', status: 'Ù…Ø­Ù„ÙˆÙ„' }
        ];

        let selectedAlertId = null; // Ù„ØªØ®Ø²ÙŠÙ† ID Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„

        // --- Ø¯ÙˆØ§Ù„ Local Storage Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© ---

        function saveAlerts() {
            try {
                localStorage.setItem('inventoryAlerts', JSON.stringify(alerts));
            } catch (e) {
                console.error("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
            }
        }

        function loadInitialData() {
            const storedAlerts = localStorage.getItem('inventoryAlerts');
            if (storedAlerts) {
                try {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                    alerts = JSON.parse(storedAlerts);
                } catch (e) {
                    console.error("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©.", e);
                    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ØŒ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                }
            }
            loadAlerts(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        }

        // --- Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ar-EG', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function updateStats() {
            const activeAlerts = alerts.filter(a => a.status === 'Ø¬Ø¯ÙŠØ¯' || a.status === 'Ù…Ù‚Ø±ÙˆØ¡');
            const criticalItems = activeAlerts.filter(a => a.currentStock < a.minLevel).length;
            const solvedAlerts = alerts.filter(a => a.status === 'Ù…Ø­Ù„ÙˆÙ„').length;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
            const totalValue = alerts.reduce((sum, a) => sum + (a.currentStock * a.costPrice), 0);

            document.getElementById('total-alerts').textContent = activeAlerts.length;
            document.getElementById('critical-items').textContent = criticalItems;
            document.getElementById('solved-alerts').textContent = solvedAlerts;
            document.getElementById('total-value').textContent = `${totalValue.toFixed(2)} SAR`;
        }

        function getStockStatus(current, min) {
            const ratio = current / min;
            let status = '';

            if (current <= 0) {
                status = 'ğŸš¨ Ù†ÙØ° - Ø´Ø±Ø§Ø¡ ÙÙˆØ±ÙŠ';
            } else if (ratio < 0.5) {
                status = 'ğŸ”¥ Ø®Ø·Ø± Ø­Ø±Ø¬';
            } else if (current < min) {
                status = 'âš ï¸ Ù…Ù†Ø®ÙØ¶';
            } else {
                status = 'âœ… Ø¬ÙŠØ¯';
            }
            
            return `<span style="font-weight: bold; color: ${ratio <= 0 ? var(--danger-color) : ratio < 0.5 ? '#ff4500' : ratio < 1 ? '#daa520' : var(--success-color)};">${status}</span>`;
        }

        function loadAlerts() {
            const tbody = document.getElementById('alerts-body');
            tbody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…

            alerts.forEach(alert => {
                let statusClass = '';
                if (alert.status === 'Ø¬Ø¯ÙŠØ¯') statusClass = 'status-new';
                else if (alert.status === 'Ù…Ù‚Ø±ÙˆØ¡') statusClass = 'status-read';
                else if (alert.status === 'Ù…Ø­Ù„ÙˆÙ„') statusClass = 'status-solved';
                else if (alert.status === 'Ù…ØªØ¬Ø§Ù‡Ù„') statusClass = 'status-ignored';
                else statusClass = 'status-read'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ

                const isSolved = alert.status === 'Ù…Ø­Ù„ÙˆÙ„' || alert.status === 'Ù…ØªØ¬Ø§Ù‡Ù„';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${alert.id}</td>
                    <td>${alert.product}</td>
                    <td>${alert.currentStock}</td>
                    <td>${alert.minLevel}</td>
                    <td>${getStockStatus(alert.currentStock, alert.minLevel)}</td>
                    <td>${alert.costPrice} / ${alert.sellingPrice} SAR</td>
                    <td>${alert.lastUpdate}</td>
                    <td><span class="${statusClass}">${alert.status}</span></td>
                    <td>
                        ${!isSolved ? `
                            <button class="btn-primary" onclick="openPurchaseModal(${alert.id})" title="Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡">Ø´Ø±Ø§Ø¡</button>
                            <button class="btn-success" onclick="openSalesModal(${alert.id})" title="Ø¥Ø¶Ø§ÙØ© Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¨ÙŠØ¹">ØªØ®ÙÙŠØ¶</button>
                            ${alert.status === 'Ø¬Ø¯ÙŠØ¯' ? 
                                `<button class="btn-secondary" onclick="markAsRead(${alert.id})" title="ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡" style="background-color: var(--info-color); color: white;">Ù…Ù‚Ø±ÙˆØ¡</button>` : ''}
                            <button class="btn-danger" onclick="openIgnoreModal(${alert.id})" title="ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹" style="background-color: var(--danger-color); color: white;">ØªØ¬Ø§Ù‡Ù„</button>
                        ` : `
                            <button class="btn-info" onclick="restoreAlert(${alert.id})" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„" style="background-color: var(--secondary-color); color: white;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                            <span style="color: var(--secondary-color);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡</span>
                        `}
                    </td>
                `;
            });
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„) ---

        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ---

        function openPurchaseModal(alertId) {
            selectedAlertId = alertId;
            const alert = alerts.find(a => a.id === alertId);
            document.getElementById('purchaseProductName').textContent = alert.product;
            document.getElementById('purchaseCost').value = alert.costPrice;
            document.getElementById('purchaseQuantity').value = alert.minLevel * 2; // Ø§Ù‚ØªØ±Ø§Ø­ ÙƒÙ…ÙŠØ©
            updatePurchaseTotalPrice(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            openModal('purchaseModal');
        }

        function updatePurchaseTotalPrice() {
            const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
            const cost = parseFloat(document.getElementById('purchaseCost').value) || 0;
            const totalPrice = quantity * cost;
            document.getElementById('purchaseTotalPrice').textContent = `${totalPrice.toFixed(2)} SAR`;
        }

        // Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        document.getElementById('purchaseQuantity').oninput = updatePurchaseTotalPrice;
        document.getElementById('purchaseCost').oninput = updatePurchaseTotalPrice;


        function submitPurchase() {
            const alert = alerts.find(a => a.id === selectedAlertId);
            const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
            const cost = parseFloat(document.getElementById('purchaseCost').value);
            const supplier = document.getElementById('purchaseSupplier').value;

            if (quantity <= 0 || cost <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± ØªÙƒÙ„ÙØ© ØµØ­ÙŠØ­ÙŠÙ†.');
                return;
            }

            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡
            console.log(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ù†ØªØ¬: ${alert.product}`);
            console.log(`Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}ØŒ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„ÙˆØ­Ø¯Ø©: ${cost}ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯: ${supplier || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø­ÙŠØ©
            alert.status = 'Ù…Ø­Ù„ÙˆÙ„';
            alert.lastUpdate = new Date().toISOString().slice(0, 10);
            
            closeModal('purchaseModal');
            loadAlerts();
            updateStats();
            saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Local Storage
            alert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ù†ØªØ¬: ${alert.product}`);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø¬Ù…Ø¹ (Batch Purchase Order)
        function createBatchPurchaseOrder() {
            // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø´Ø±Ø§Ø¡: (Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 50% Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰) Ø£Ùˆ Ù†ÙØ°Øª
            const itemsToBuy = alerts.filter(a => a.currentStock < a.minLevel * 0.5 && a.status !== 'Ù…Ø­Ù„ÙˆÙ„' && a.status !== 'Ù…ØªØ¬Ø§Ù‡Ù„');

            if (itemsToBuy.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø¬Ù…Ø¹.');
                return;
            }

            let orderList = 'Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ù…Ø¬Ù…Ø¹:\n';
            let totalOrderCost = 0;

            itemsToBuy.forEach(item => {
                const requiredQty = (item.minLevel * 2) - item.currentStock; // Ø§Ù‚ØªØ±Ø§Ø­ ÙƒÙ…ÙŠØ© Ø¶Ø¹Ù Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù†Ø§Ù‚Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                const itemCost = requiredQty * item.costPrice;
                totalOrderCost += itemCost;
                
                orderList += `\n- Ø§Ù„Ù…Ù†ØªØ¬: ${item.product}`;
                orderList += ` (ID: ${item.id}) | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${requiredQty} Ø­Ø¨Ø©`;
                orderList += ` | Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: ${itemCost.toFixed(2)} SAR`;
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡Ø§
                item.status = 'Ù…Ù‚Ø±ÙˆØ¡';
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
            loadAlerts();
            updateStats();
            saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±

            orderList += `\n\n- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø·Ù„Ø¨: ${totalOrderCost.toFixed(2)} SAR.`;
            
            alert(orderList); // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ù…Ù„Ù PDF)
        }

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®ÙÙŠØ¶Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ© ---

        function openSalesModal(alertId) {
            selectedAlertId = alertId;
            const alert = alerts.find(a => a.id === alertId);
            document.getElementById('saleProductName').textContent = alert.product;
            document.getElementById('saleOriginalPrice').textContent = `${alert.sellingPrice.toFixed(2)} SAR`;
            document.getElementById('saleCostPrice').textContent = `${alert.costPrice.toFixed(2)} SAR`;
            
            // ØªØ¹ÙŠÙŠÙ† Ø®ØµÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹
            const defaultDiscount = alert.currentStock < alert.minLevel * 0.3 ? 20 : 10;
            document.getElementById('saleDiscount').value = defaultDiscount;

            calculateSaleProfit(); // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ ÙÙˆØ±Ø§Ù‹
            openModal('salesModal');
        }

        function calculateSaleProfit() {
            const alert = alerts.find(a => a.id === selectedAlertId);
            if (!alert) return;

            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const originalPrice = alert.sellingPrice;
            const costPrice = alert.costPrice;
            const statusElement = document.getElementById('saleProfitStatus');
            const newPriceElement = document.getElementById('saleNewPrice');

            const newPrice = originalPrice * (1 - discount / 100);
            const profitMargin = newPrice - costPrice;
            
            newPriceElement.textContent = `${newPrice.toFixed(2)} SAR`;

            if (profitMargin > 0) {
                statusElement.textContent = `âœ… Ø±Ø¨Ø­ Ù…ØªÙˆÙ‚Ø¹: ${profitMargin.toFixed(2)} SAR`;
                statusElement.style.color = var(--success-color);
            } else if (profitMargin === 0) {
                statusElement.textContent = `âš ï¸ Ù†Ù‚Ø·Ø© ØªØ¹Ø§Ø¯Ù„: Ù„Ø§ Ø±Ø¨Ø­ ÙˆÙ„Ø§ Ø®Ø³Ø§Ø±Ø©.`;
                statusElement.style.color = '#daa520';
            } else {
                statusElement.textContent = `âŒ Ø®Ø³Ø§Ø±Ø© Ù…ØªÙˆÙ‚Ø¹Ø©: ${Math.abs(profitMargin).toFixed(2)} SAR (Ø¨ÙŠØ¹ Ø¨Ø®Ø³Ø§Ø±Ø©!)`;
                statusElement.style.color = var(--danger-color);
            }
        }

        function submitSaleOffer() {
            const alert = alerts.find(a => a.id === selectedAlertId);
            const discount = parseFloat(document.getElementById('saleDiscount').value);

            if (discount <= 0 || discount > 100) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø®ØµÙ… ØµØ­ÙŠØ­Ø© Ø¨ÙŠÙ† 1% Ùˆ 100%.');
                return;
            }
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ®ÙÙŠØ¶
            console.log(`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ ØªØ®ÙÙŠØ¶ ${discount}% Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ${alert.product}`);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            alert.status = 'Ù…Ø­Ù„ÙˆÙ„';
            alert.lastUpdate = new Date().toISOString().slice(0, 10);

            closeModal('salesModal');
            loadAlerts();
            updateStats();
            saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±
            alert(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø¨Ù†Ø³Ø¨Ø© ${discount}% Ù„Ù„Ù…Ù†ØªØ¬: ${alert.product}`);
        }

        // --- Ø¯ÙˆØ§Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ---

        function markAsRead(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (alert && alert.status === 'Ø¬Ø¯ÙŠØ¯') {
                alert.status = 'Ù…Ù‚Ø±ÙˆØ¡';
                alert.lastUpdate = new Date().toISOString().slice(0, 10);
                loadAlerts();
                updateStats();
                saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±
            }
        }
        
        function openIgnoreModal(alertId) {
            selectedAlertId = alertId;
            const alert = alerts.find(a => a.id === alertId);
            document.getElementById('ignoreProductName').textContent = alert.product;
            document.getElementById('ignoreReason').value = '';
            openModal('ignoreModal');
        }

        function ignoreAlertConfirmed() {
            const alert = alerts.find(a => a.id === selectedAlertId);
            const reason = document.getElementById('ignoreReason').value.trim();

            if (!reason) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØªØ¬Ø§Ù‡Ù„.');
                return;
            }
            
            alert.status = 'Ù…ØªØ¬Ø§Ù‡Ù„';
            alert.lastUpdate = new Date().toISOString().slice(0, 10);

            closeModal('ignoreModal');
            loadAlerts();
            updateStats();
            saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±
            alert(`âœ… ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ù†ØªØ¬: ${alert.product}. Ø§Ù„Ø³Ø¨Ø¨: ${reason}`);
        }

        function restoreAlert(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (alert && (alert.status === 'Ù…Ø­Ù„ÙˆÙ„' || alert.status === 'Ù…ØªØ¬Ø§Ù‡Ù„')) {
                alert.status = 'Ø¬Ø¯ÙŠØ¯';
                alert.lastUpdate = new Date().toISOString().slice(0, 10);
                loadAlerts();
                updateStats();
                saveAlerts(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±
                alert('âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ø­Ø§Ù„Ø© "Ø¬Ø¯ÙŠØ¯".');
            }
        }


        // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
        window.onload = function() {
            loadInitialData(); // ØªØ¨Ø¯Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Local Storage Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            updateStats();
            updateTime();
            setInterval(updateTime, 1000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        };
    </script>
</body>
</html>
